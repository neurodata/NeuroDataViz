<!DOCTYPE html>
<html>
<!--
# Copyright 2016 NeuroData (http://neurodata.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Designed, Developed, and Maintained by Alex Baden
# abaden1@jhu.edu
# github.com/alexbaden

!-->
<head>
  <title>NeuroDataViz: viewing {{ project_name }}</title>
  {% load staticfiles %}
  {# boostrap files #}
  <link rel="stylesheet" type ="text/css" href="{% static 'bootstrap/css/bootstrap.css' %}" />

  {# jquery -- TODO remove once the internet is unbroken #}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

  {# jquery UI #}
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">

  {# buttons, buttons, buttons #}
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  {# css file #}
  <link rel="stylesheet" href="{% static 'ndv/css/viewer.css' %}" />

  {% if GOOGLE_ANALYTICS_PROPERTY_ID %}
    {% include "ndv/analytics.html" %}
  {% endif %}
	</head>
<body>
  <div class="modal fade" id="no_webgl" tabindex="-1" role="dialog" aria-labelledby="no_webgl_modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close"><span aria-hidden="true">&times;</span></button>
          <h3 class="modal-title" id="no_webgl_modal_label">Error Initializing WebGL</h3>
        </div>
        <div class="modal-body bg-danger" id="no_webgl_body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="layerControls" tabindex="-1" role="dialog" aria-labelledby="layerControlsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h3 class="modal-title" id="layerControlsLabel">Layer Controls</h3>
        </div>
        <div class="modal-body" id="layerControlsContainer">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
       </div>
     </div>
  </div>

  {# Begin Modal Code Includes #}
  {% include "ndv/help.html" %}

  {% include "ndv/nav.html" %}

  {# {% include "ndv/login.html" %} #}

  {% include "ndv/blendmodes.html" %}
  {# End Modal Code Includes #}

  <div id="react-target"></div>

  <script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  </script>

  <script id="fragmentShader" type="x-shader/x-fragment">
    varying vec2 vUv;

    uniform vec3 color;
    uniform sampler2D texture;

    uniform float opacity;

    // remapping
    uniform float minval;
    uniform float maxval;

    // gamma
    uniform float gamma;

    void main() {
      vec4 tmpColor;

      #ifdef REMAP
      tmpColor = texture2D(texture, vUv) * vec4(color.x, color.y, color.z, opacity);
      // remap color to new intensity range
      tmpColor.x = min( max( (tmpColor.x - minval)/maxval, 0.0), 1.0 );
      tmpColor.y = min( max( (tmpColor.y - minval)/maxval, 0.0), 1.0 );
      tmpColor.z = min( max( (tmpColor.z - minval)/maxval, 0.0), 1.0 );
      #else
      tmpColor = texture2D(texture, vUv) * vec4(color.x, color.y, color.z, opacity);
      #endif

      #ifdef GAMMACOR
      tmpColor.rgb = pow(tmpColor.rgb, vec3(1.0 / gamma));
      #endif

      gl_FragColor = tmpColor;

    }
  </script>
  <script>
  window.config = new Object();

  window.config.currentServer = "{{ request.META.HTTP_HOST }}";

  window.config.xstart = {{ xstart }};
  window.config.xoffset = {{ xoffset }};
  window.config.xsize = {{ xsize }};

  window.config.ystart = {{ ystart }};
  window.config.yoffset = {{ yoffset }};
  window.config.ysize = {{ ysize }};

  window.config.zstart = {{ zstart }};
  window.config.zoffset = {{ zoffset }};
  window.config.zsize = {{ zsize }};

  window.config.minres = {{ minres }};
  window.config.maxres = {{ maxres }};
  window.config.res = {{ res }};

  window.config.layers = [];

  window.addLayer = function(name, type, propagate, url, server, token, channel, color, backend) {
    var tmpLayer = {};

    tmpLayer.name = name;
    tmpLayer.type = type;
    tmpLayer.propagate = propagate;
    tmpLayer.url = url;
    tmpLayer.server = server;
    tmpLayer.token = token;
    tmpLayer.channel = channel;
    tmpLayer.color = color;
    tmpLayer.tilesize = 512;
    tmpLayer.backend = backend;

    window.config.layers.push(tmpLayer);
  }

  {% for layer in layers %}

    {% if viewtype == 'renderview' %}

    var url = "http://{{ request.META.HTTP_HOST }}/getRenderTile/{{ renderServer }}/{{ owner }}/{{ layer.token }}/{{ layer.channel }}/xy/{z}/{y}_{x}_{res}.png";

    window.addLayer("{{ layer.layer_name|cut:" " }}", "{{ layer.layertype }}", 2, url, "{{ layer.server }}", "{{ layer.token }}", "{{ layer.channel }}", "{{ layer.color }}", 'render');

    {% else %}

    {% if layer.channel %}
    var webtoken = '{{ layer.token }}/{{ layer.channel }}';
    {% else %}
    var webtoken = '{{ layer.token }}';
    {% endif %}
    var url = 'http://{{ layer.server }}/nd/catmaid/' + webtoken + '/xy/{z}/{y}_{x}_{res}.png';
    console.log('url = ' + url);

    window.addLayer("{{ layer.layer_name|cut:" " }}", "{{ layer.layertype }}", "{{ layer.propagate }}", url, "{{ layer.server }}", "{{ layer.token }}", "{{ layer.channel }}", "{{ layer.color }}", 'ndstore');
    {% endif %}
  {% endfor %}

  </script>

</body>
{# jquery and bootstrap js #}

<script src="{% static 'js/app.bundle.js' %}"></script>

<script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
{# jquery ui (for slider) #}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
{# jquery ui on mobile #}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
</html>
